<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Traductor n8n</title>
  <style>
  :root{
    --bg1:#070712; --bg2:#0b1026;
    --cardA: rgba(255,255,255,.08);
    --cardB: rgba(255,255,255,.04);
    --stroke: rgba(255,255,255,.14);
    --stroke2: rgba(255,255,255,.10);

    --text:#f4f6ff;
    --muted: rgba(244,246,255,.70);

    --accent:#7c5cff;
    --accent2:#2ee59d;

    --danger:#ff6b6b;

    --shadow: 0 28px 90px rgba(0,0,0,.55);
    --shadow2: 0 14px 35px rgba(0,0,0,.28);

    --radius: 18px;
    --radius2: 14px;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }

  body{
    margin:0;
    font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
    color:var(--text);
    min-height:100vh;
    background:
      radial-gradient(1200px 600px at 12% 20%, rgba(124,92,255,.35), transparent 60%),
      radial-gradient(900px 500px at 85% 22%, rgba(46,229,157,.22), transparent 55%),
      radial-gradient(1000px 600px at 40% 95%, rgba(124,92,255,.16), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    padding: 28px 18px 48px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* contenedor m√°s ‚Äúaireado‚Äù */
  .wrap{ width:min(1020px, 100%); }

  .top{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:14px;
    margin-bottom: 16px;
  }

  .brand{ display:flex; gap:12px; align-items:center; }

  .logo{
    width:46px; height:46px;
    border-radius: 16px;
    background: linear-gradient(135deg, rgba(124,92,255,1), rgba(46,229,157,.78));
    box-shadow: 0 14px 38px rgba(124,92,255,.20);
    position: relative;
    overflow:hidden;
  }
  .logo:after{
    content:"";
    position:absolute; inset:-30%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 60%);
    transform: rotate(18deg);
  }

  h1{
    margin:0;
    font-size: 24px;
    letter-spacing:.2px;
    line-height:1.05;
  }
  .sub{
    margin:6px 0 0;
    color: var(--muted);
    font-size: 13.5px;
    line-height:1.35;
  }

  .pill{
    padding: 10px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,.07);
    border: 1px solid var(--stroke);
    color: rgba(244,246,255,.84);
    font-size: 12px;
    display:flex;
    gap:8px;
    align-items:center;
    box-shadow: var(--shadow2);
    backdrop-filter: blur(10px);
    white-space: nowrap;
  }
  .dot{
    width:8px; height:8px; border-radius:50%;
    background: var(--accent2);
    box-shadow: 0 0 0 6px rgba(46,229,157,.10);
  }

  /* Card con borde y brillo sutil */
  .card{
    background: linear-gradient(180deg, var(--cardA), var(--cardB));
    border: 1px solid var(--stroke2);
    border-radius: calc(var(--radius) + 2px);
    box-shadow: var(--shadow);
    overflow:hidden;
    backdrop-filter: blur(14px);
    position: relative;
  }
  .card:before{
    content:"";
    position:absolute;
    inset:0;
    pointer-events:none;
    background: radial-gradient(900px 260px at 18% 10%, rgba(124,92,255,.18), transparent 60%);
  }

  .toolbar{
    padding: 16px 16px 6px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    position: relative;
  }

  .controls{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
  }
  label{
    font-size: 12px;
    color: rgba(244,246,255,.72);
    margin-right: 2px;
  }

  select{
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(12,14,28,.55);
    color: var(--text);
    outline: none;
    min-width: 190px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    transition: border-color .15s ease, transform .05s ease;
  }
  select:focus{
    border-color: rgba(124,92,255,.55);
  }

  .btn{
    border:0;
    padding: 10px 14px;
    border-radius: 12px;
    font-weight: 750;
    letter-spacing:.2px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:10px;
    color: #0a0b12;
    background: linear-gradient(135deg, var(--accent), #a58cff);
    box-shadow: 0 14px 34px rgba(124,92,255,.22);
    transition: transform .08s ease, filter .15s ease, box-shadow .15s ease;
    user-select:none;
  }
  .btn:hover{ filter: brightness(1.03); }
  .btn:active{ transform: translateY(1px); }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }

  .btn.secondary{
    background: rgba(255,255,255,.08);
    color: var(--text);
    border: 1px solid rgba(255,255,255,.14);
    box-shadow: none;
  }

  .btn.ghost{
    background: rgba(255,255,255,.03);
    color: rgba(244,246,255,.92);
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: none;
  }

  /* WhatsApp */
  .btn.whatsapp{
    background: linear-gradient(135deg, #25D366, #1ebe5d);
    color: #062c1b;
    box-shadow: 0 14px 30px rgba(37,211,102,.16);
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    padding: 14px 16px 16px;
    position: relative;
  }

  @media (max-width: 860px){
    body{ padding: 18px 12px 34px; }
    .top{ align-items:flex-start; flex-direction:column; }
    .pill{ align-self:flex-start; }
    .grid{ grid-template-columns: 1fr; }
    select{ min-width: 170px; }
  }

  .panel{
    background: rgba(10,12,24,.48);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: var(--radius);
    padding: 12px;
    min-height: 240px;
    display:flex;
    flex-direction:column;
    gap: 10px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  }

  .panel h2{
    margin:0;
    font-size: 13px;
    color: rgba(244,246,255,.86);
    font-weight: 800;
    letter-spacing:.2px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .small{
    font-size: 12px;
    color: rgba(244,246,255,.62);
    font-weight: 600;
  }

  textarea{
    width:100%;
    flex: 1;
    resize: vertical;
    min-height: 160px;
    padding: 12px 12px;
    border-radius: var(--radius);
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(6,7,14,.55);
    color: var(--text);
    outline:none;
    line-height:1.45;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    transition: border-color .15s ease;
  }
  textarea:focus{
    border-color: rgba(124,92,255,.55);
  }

  .out{
    flex:1;
    padding: 12px;
    border-radius: var(--radius);
    border: 1px dashed rgba(255,255,255,.20);
    background: rgba(6,7,14,.40);
    white-space: pre-wrap;
    overflow:auto;
    min-height: 160px;
  }

  .status{
    padding: 12px 16px 14px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    border-top: 1px solid rgba(255,255,255,.10);
    color: rgba(244,246,255,.72);
    font-size: 12px;
    position: relative;
  }

  .error{ color: var(--danger); font-weight: 800; }
  .ok{ color: var(--accent2); font-weight: 800; }

  .spinner{
    width: 14px; height: 14px;
    border-radius: 50%;
    border: 2px solid rgba(10,11,18,.25);
    border-top-color: rgba(10,11,18,.95);
    display:inline-block;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .toast{
    position: fixed;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(15,18,34,.92);
    border: 1px solid rgba(255,255,255,.16);
    padding: 10px 12px;
    border-radius: 999px;
    color: rgba(244,246,255,.92);
    font-size: 12px;
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
    opacity: 0;
    pointer-events:none;
    transition: opacity .18s ease;
  }
  .toast.show{ opacity: 1; }

  /* Chat Widget */
  .chat-widget{
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9999;
  }

  .chat-button{
    width: 62px;
    height: 62px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #a58cff);
    border: 0;
    box-shadow: 0 18px 50px rgba(124,92,255,.35), 0 0 0 0 rgba(124,92,255,.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    transition: transform .15s ease, box-shadow .15s ease;
    animation: pulse 2s infinite;
  }
  .chat-button:hover{
    transform: scale(1.05);
    box-shadow: 0 20px 60px rgba(124,92,255,.45), 0 0 0 0 rgba(124,92,255,.4);
  }
  .chat-button:active{
    transform: scale(0.95);
  }

  @keyframes pulse {
    0% { box-shadow: 0 18px 50px rgba(124,92,255,.35), 0 0 0 0 rgba(124,92,255,.4); }
    70% { box-shadow: 0 18px 50px rgba(124,92,255,.35), 0 0 0 12px rgba(124,92,255,0); }
    100% { box-shadow: 0 18px 50px rgba(124,92,255,.35), 0 0 0 0 rgba(124,92,255,0); }
  }

  .chat-window{
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 380px;
    height: 550px;
    background: linear-gradient(180deg, rgba(15,18,38,.96), rgba(11,14,30,.98));
    border: 1px solid rgba(255,255,255,.16);
    border-radius: 20px;
    box-shadow: 0 28px 80px rgba(0,0,0,.60);
    backdrop-filter: blur(20px);
    display: flex;
    flex-direction: column;
    opacity: 0;
    transform: translateY(20px) scale(0.95);
    pointer-events: none;
    transition: opacity .25s ease, transform .25s ease;
  }
  .chat-window.open{
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
  }

  .chat-header{
    padding: 18px 20px;
    background: linear-gradient(135deg, rgba(124,92,255,.18), rgba(46,229,157,.12));
    border-bottom: 1px solid rgba(255,255,255,.12);
    border-radius: 20px 20px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .chat-header-info{
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .chat-avatar{
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), rgba(46,229,157,.88));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 8px 20px rgba(124,92,255,.25);
  }

  .chat-header-text h3{
    margin: 0;
    font-size: 15px;
    font-weight: 800;
    color: var(--text);
  }
  .chat-header-text p{
    margin: 2px 0 0;
    font-size: 11px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .online-dot{
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--accent2);
    box-shadow: 0 0 0 4px rgba(46,229,157,.15);
  }

  .chat-close{
    width: 32px;
    height: 32px;
    border: 0;
    background: rgba(255,255,255,.08);
    border-radius: 8px;
    color: rgba(244,246,255,.80);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: background .15s ease;
  }
  .chat-close:hover{
    background: rgba(255,255,255,.14);
  }

  .chat-messages{
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .chat-message{
    display: flex;
    gap: 10px;
    animation: messageSlide .3s ease;
  }
  @keyframes messageSlide {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chat-message.user{
    flex-direction: row-reverse;
  }

  .message-avatar{
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(46,229,157,.45));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
  }

  .chat-message.user .message-avatar{
    background: linear-gradient(135deg, rgba(46,229,157,.55), rgba(124,92,255,.45));
  }

  .message-bubble{
    max-width: 70%;
    padding: 12px 14px;
    border-radius: 16px;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.10);
    color: var(--text);
    font-size: 13.5px;
    line-height: 1.5;
    box-shadow: 0 4px 12px rgba(0,0,0,.15);
  }

  .chat-message.user .message-bubble{
    background: linear-gradient(135deg, rgba(124,92,255,.35), rgba(124,92,255,.25));
    border-color: rgba(124,92,255,.40);
  }

  .message-time{
    font-size: 10px;
    color: rgba(244,246,255,.50);
    margin-top: 4px;
  }

  .chat-input-area{
    padding: 16px;
    border-top: 1px solid rgba(255,255,255,.10);
    background: rgba(6,8,18,.55);
    border-radius: 0 0 20px 20px;
  }

  .chat-input-wrapper{
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  .chat-input{
    flex: 1;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(10,12,24,.65);
    color: var(--text);
    font-size: 13px;
    outline: none;
    resize: none;
    max-height: 100px;
    font-family: inherit;
    line-height: 1.4;
    transition: border-color .15s ease;
  }
  .chat-input:focus{
    border-color: rgba(124,92,255,.55);
  }

  .chat-send{
    width: 44px;
    height: 44px;
    border: 0;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--accent), #a58cff);
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: transform .08s ease, filter .15s ease;
    box-shadow: 0 8px 20px rgba(124,92,255,.25);
    flex-shrink: 0;
  }
  .chat-send:hover{
    filter: brightness(1.1);
  }
  .chat-send:active{
    transform: scale(0.95);
  }
  .chat-send:disabled{
    opacity: .5;
    cursor: not-allowed;
  }

  @media (max-width: 480px){
    .chat-window{
      width: calc(100vw - 24px);
      height: calc(100vh - 100px);
      bottom: 80px;
      right: 12px;
    }
    .chat-widget{
      right: 12px;
      bottom: 12px;
    }
  }
</style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Traductor n8n + IA</h1>
          <div class="sub">Escribe el texto, elige el idioma destino y obt√©n la traducci√≥n al instante.</div>
        </div>
      </div>
      <div class="pill"><span class="dot"></span>Webhook activo (producci√≥n)</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="controls">
          <label for="target">Idioma destino</label>
          <select id="target" title="Idioma destino">
            <option value="es">Espa√±ol (es)</option>
            <option value="en">Ingl√©s (en)</option>
            <option value="fr">Franc√©s (fr)</option>
            <option value="pt">Portugu√©s (pt)</option>
            <option value="de">Alem√°n (de)</option>
            <option value="it">Italiano (it)</option>
          </select>

          <button class="btn" id="btn" type="button">
            <span id="btnIcon">ü™Ñ</span>
            <span id="btnText">Traducir</span>
          </button>

          <button class="btn secondary" id="btnClear" type="button">Limpiar</button>

          <!-- Bot√≥n WhatsApp -->
          <button class="btn whatsapp" id="shareWa" type="button" title="Compartir por WhatsApp">
            üì≤ WhatsApp
          </button>
        </div>

        <div class="small" id="charCount">0 caracteres</div>
      </div>

      <div class="grid">
        <div class="panel">
          <h2>
            Texto original
            <span class="small">Tip: puedes pegar p√°rrafos largos</span>
          </h2>
          <textarea id="text" placeholder="Ej: Hello world..."></textarea>
        </div>

        <div class="panel">
          <h2>
            Traducci√≥n
            <button class="btn secondary" id="copy" type="button">Copiar</button>
          </h2>
          <div id="out" class="out"></div>
        </div>
      </div>

      <div class="status">
        <div id="statusLeft"></div>
        <div id="statusRight">Fuente: Ollama (llama3.2)</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Copiado ‚úÖ</div>

  <!-- Chat Widget -->
  <div class="chat-widget">
    <button class="chat-button" id="chatToggle" type="button" aria-label="Abrir chat">
      üí¨
    </button>

    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <div class="chat-header-info">
          <div class="chat-avatar">ü§ñ</div>
          <div class="chat-header-text">
            <h3>Soporte IA</h3>
            <p><span class="online-dot"></span>En l√≠nea</p>
          </div>
        </div>
        <button class="chat-close" id="chatClose" type="button" aria-label="Cerrar chat">‚úï</button>
      </div>

      <div class="chat-messages" id="chatMessages">
        <!-- Los mensajes se agregan din√°micamente -->
      </div>

      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea 
            class="chat-input" 
            id="chatInput" 
            placeholder="Escribe tu mensaje..."
            rows="1"></textarea>
          <button class="chat-send" id="chatSend" type="button" aria-label="Enviar mensaje">üì§</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const OLLAMA_URL = "https://four-days-play.loca.lt";

    const $ = (id) => document.getElementById(id);
    const btn = $("btn");
    const btnText = $("btnText");
    const btnIcon = $("btnIcon");
    const out = $("out");
    const statusLeft = $("statusLeft");
    const charCount = $("charCount");
    const toast = $("toast");

    function toastShow(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=> toast.classList.remove("show"), 1200);
    }

    function setLoading(isLoading){
      btn.disabled = isLoading;
      btnIcon.innerHTML = isLoading ? "<span class='spinner'></span>" : "ü™Ñ";
      btnText.textContent = isLoading ? "Traduciendo..." : "Traducir";
    }

    $("text").addEventListener("input", () => {
      charCount.textContent = `${$("text").value.length} caracteres`;
    });

    $("btnClear").addEventListener("click", () => {
      $("text").value = "";
      out.textContent = "";
      statusLeft.textContent = "Listo.";
      charCount.textContent = "0 caracteres";
    });

    $("copy").addEventListener("click", async () => {
      const txt = out.textContent.trim();
      if (!txt) return toastShow("Nada para copiar");
      try{
        await navigator.clipboard.writeText(txt);
        toastShow("Copiado ‚úÖ");
      }catch{
        toastShow("No se pudo copiar");
      }
    });

    // ‚úÖ Compartir por WhatsApp (SOLO EL LINK)
    $("shareWa").addEventListener("click", () => {
      const url = window.location.href;  // esto ser√° tu link de GitHub Pages
      const waUrl = "https://wa.me/?text=" + encodeURIComponent(url);
      window.open(waUrl, "_blank");
    });

    btn.addEventListener("click", async () => {
      const text = $("text").value.trim();
      const target = $("target").value;

      if (!text){
        out.innerHTML = "<span style='color: var(--danger); font-weight:700;'>Escribe un texto para traducir.</span>";
        statusLeft.innerHTML = "<span class='error'>Falta texto.</span>";
        return;
      }

      setLoading(true);
      statusLeft.textContent = "Traduciendo con IA...";

      try{
        // Mapa de c√≥digos de idioma a nombres completos
        const languages = {
          'es': 'espa√±ol',
          'en': 'ingl√©s',
          'fr': 'franc√©s',
          'pt': 'portugu√©s',
          'de': 'alem√°n',
          'it': 'italiano'
        };

        const targetLang = languages[target] || target;

        // Llamada a Ollama para traducci√≥n
        const res = await fetch(`${OLLAMA_URL}/api/chat`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "llama3.2",
            messages: [
              {
                role: "system",
                content: `Eres un traductor profesional. Tu √∫nica tarea es traducir el texto que te proporcionen al idioma ${targetLang}. Responde √öNICAMENTE con la traducci√≥n, sin explicaciones, sin comentarios adicionales, solo el texto traducido.`
              },
              {
                role: "user",
                content: text
              }
            ],
            stream: false
          })
        });

        if (!res.ok){
          const errorText = await res.text().catch(() => "");
          out.innerHTML = "<span class='error'>Error en el servidor: " + (res.statusText || "Error desconocido") + "</span>";
          statusLeft.innerHTML = "<span class='error'>Error.</span>";
        } else {
          const data = await res.json();
          const translation = data.message?.content || "(sin traducci√≥n)";
          out.textContent = translation;
          statusLeft.innerHTML = "<span class='ok'>‚úì</span> Traducido a <b>"+ targetLang +"</b>";
        }
      }catch(e){
        console.error("Error de traducci√≥n:", e);
        out.innerHTML = "<span class='error'>No se pudo conectar al servidor de Ollama. Verifica que el servicio est√© activo.</span>";
        statusLeft.innerHTML = "<span class='error'>Sin conexi√≥n.</span>";
      }finally{
        setLoading(false);
      }
    });

    // Chat Widget functionality
    const chatToggle = $("chatToggle");
    const chatWindow = $("chatWindow");
    const chatClose = $("chatClose");
    const chatMessages = $("chatMessages");
    const chatInput = $("chatInput");
    const chatSend = $("chatSend");

    // Funci√≥n para obtener hora actual
    function getCurrentTime(){
      const now = new Date();
      return now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    }

    // Funci√≥n para agregar mensaje al chat
    function addMessage(text, isUser = false){
      const messageDiv = document.createElement("div");
      messageDiv.className = "chat-message" + (isUser ? " user" : "");
      
      const avatar = document.createElement("div");
      avatar.className = "message-avatar";
      avatar.textContent = isUser ? "üë§" : "ü§ñ";
      
      const contentDiv = document.createElement("div");
      
      const bubble = document.createElement("div");
      bubble.className = "message-bubble";
      bubble.textContent = text;
      
      const time = document.createElement("div");
      time.className = "message-time";
      time.textContent = getCurrentTime();
      
      contentDiv.appendChild(bubble);
      contentDiv.appendChild(time);
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Mensaje de bienvenida al abrir el chat por primera vez
    let chatOpened = false;
    
    function toggleChat(){
      chatWindow.classList.toggle("open");
      if(chatWindow.classList.contains("open")){
        chatInput.focus();
        
        // Mostrar mensaje de bienvenida solo la primera vez
        if(!chatOpened){
          chatOpened = true;
          setTimeout(() => {
            addMessage("¬°Hola! üëã Bienvenido al Traductor n8n + IA");
          }, 300);
          setTimeout(() => {
            addMessage("Soy tu asistente virtual. ¬øEn qu√© puedo ayudarte hoy?");
          }, 900);
          setTimeout(() => {
            addMessage("Puedo responder preguntas sobre c√≥mo usar el traductor, los idiomas disponibles, o cualquier duda que tengas. üòä");
          }, 1500);
        }
      }
    }

    chatToggle.addEventListener("click", toggleChat);
    chatClose.addEventListener("click", toggleChat);

    // Auto-resize textarea
    chatInput.addEventListener("input", function(){
      this.style.height = "auto";
      this.style.height = Math.min(this.scrollHeight, 100) + "px";
    });

    // Enviar mensaje con Enter (Shift+Enter para nueva l√≠nea)
    chatInput.addEventListener("keydown", function(e){
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        chatSend.click();
      }
    });

    // Funci√≥n para enviar mensaje a Ollama
    chatSend.addEventListener("click", async function(){
      const message = chatInput.value.trim();
      if(!message) return;

      // Guardar el mensaje antes de limpiar
      const userMessage = message;
      
      // Limpiar input primero
      chatInput.value = "";
      chatInput.style.height = "auto";

      // Mostrar mensaje del usuario
      addMessage(userMessage, true);

      // Deshabilitar bot√≥n mientras se procesa
      chatSend.disabled = true;

      // Mostrar indicador de escritura
      const typingDiv = document.createElement("div");
      typingDiv.className = "chat-message";
      typingDiv.id = "typing-indicator";
      typingDiv.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div>
          <div class="message-bubble">
            <span class="spinner"></span> Escribiendo...
          </div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      try {
        // Llamada a Ollama
        const response = await fetch(`${OLLAMA_URL}/api/chat`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "llama3.2",
            messages: [
              {
                role: "system",
                content: "Eres un asistente √∫til del Traductor n8n + IA. Ayudas a los usuarios con preguntas sobre c√≥mo usar el traductor, los idiomas disponibles, y cualquier duda relacionada con la aplicaci√≥n. Responde de manera amigable y concisa."
              },
              {
                role: "user",
                content: message
              }
            ],
            stream: false
          })
        });

        // Remover indicador de escritura
        const typing = document.getElementById("typing-indicator");
        if(typing) typing.remove();

        if(response.ok){
          const data = await response.json();
          const aiResponse = data.message?.content || "Lo siento, no pude generar una respuesta.";
          addMessage(aiResponse);
        } else {
          addMessage("Lo siento, hubo un error al conectar con el servidor. Por favor intenta nuevamente.");
        }
      } catch(error) {
        console.error("Error:", error);
        const typing = document.getElementById("typing-indicator");
        if(typing) typing.remove();
        addMessage("No pude conectarme al servidor. Verifica que el servicio de Ollama est√© activo.");
      } finally {
        chatSend.disabled = false;
      }
    });
  </script>
</body>
</html>

