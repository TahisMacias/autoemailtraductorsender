<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Traductor n8n</title>
  <style>
  :root{
    --bg1:#0f1419; --bg2:#1a1f2e;
    --cardA: rgba(255,255,255,.03);
    --cardB: rgba(255,255,255,.01);
    --stroke: rgba(255,255,255,.08);
    --stroke2: rgba(255,255,255,.05);

    --text:#e8eaed;
    --muted: rgba(232,234,237,.65);

    --accent:#3b82f6;
    --accent2:#2563eb;

    --danger:#ef4444;

    --shadow: 0 20px 60px rgba(0,0,0,.3);
    --shadow2: 0 8px 24px rgba(0,0,0,.15);

    --radius: 12px;
    --radius2: 8px;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }

  body{
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
    color:var(--text);
    min-height:100vh;
    background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
    padding: 40px 24px 60px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* contenedor m√°s ‚Äúaireado‚Äù */
  .wrap{ width:min(1020px, 100%); }

  .top{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:14px;
    margin-bottom: 16px;
  }

  .brand{ display:flex; gap:12px; align-items:center; }

  .logo{
    width:46px; height:46px;
    border-radius: 10px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    box-shadow: 0 4px 12px rgba(59,130,246,.25);
    position: relative;
    overflow:hidden;
  }
  .logo:after{
    content:"";
    position:absolute;
    inset:-30%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.2), transparent 60%);
    transform: rotate(18deg);
  }

  h1{
    margin:0;
    font-size: 24px;
    letter-spacing:-0.5px;
    line-height:1.2;
    font-weight: 600;
    color: var(--text);
  }
  .sub{
    margin:6px 0 0;
    color: var(--muted);
    font-size: 13.5px;
    line-height:1.35;
  }

  .pill{
    padding: 8px 14px;
    border-radius: 20px;
    background: rgba(59,130,246,.1);
    border: 1px solid rgba(59,130,246,.2);
    color: rgba(59,130,246,1);
    font-size: 11px;
    font-weight: 600;
    display:flex;
    gap:8px;
    align-items:center;
    white-space: nowrap;
  }
  .dot{
    width:6px; height:6px; border-radius:50%;
    background: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59,130,246,.15);
  }

  /* Card con borde y brillo sutil */
  .card{
    background: rgba(26,31,46,.6);
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
    backdrop-filter: blur(20px);
    position: relative;
  }
  .card:before{
    content:"";
    position:absolute;
    top:0;
    left:0;
    right:0;
    height:1px;
    background: linear-gradient(90deg, transparent, rgba(59,130,246,.3), transparent);
    pointer-events:none;
  }

  .toolbar{
    padding: 16px 16px 6px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    position: relative;
  }

  .controls{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
  }
  label{
    font-size: 12px;
    color: rgba(244,246,255,.72);
    margin-right: 2px;
  }

  select{
    padding: 11px 14px;
    border-radius: var(--radius2);
    border: 1px solid var(--stroke);
    background: rgba(26,31,46,.8);
    color: var(--text);
    outline: none;
    min-width: 180px;
    font-size: 14px;
    transition: border-color .2s ease;
  }
  select:focus{
    border-color: var(--accent);
  }

  .btn{
    border:0;
    padding: 11px 20px;
    border-radius: var(--radius2);
    font-weight: 600;
    font-size: 14px;
    letter-spacing:-0.2px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    color: #fff;
    background: #2563eb;
    box-shadow: 0 2px 8px rgba(37,99,235,.2);
    transition: all .2s ease;
    user-select:none;
    min-width: 120px;
  }
  .btn:hover{ 
    background: #1d4ed8;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37,99,235,.3);
  }
  .btn:active{ 
    transform: translateY(0);
    background: #1e40af;
  }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }

  .btn.secondary{
    background: rgba(255,255,255,.08);
    color: var(--text);
    border: 1px solid var(--stroke);
    box-shadow: none;
    padding: 6px 10px;
    font-size: 12px;
  }
  .btn.secondary:hover{
    background: rgba(255,255,255,.12);
    border-color: rgba(255,255,255,.15);
  }

  .btn.ghost{
    background: transparent;
    color: var(--accent);
    border: 1px solid var(--accent);
    box-shadow: none;
  }
  .btn.ghost:hover{
    background: rgba(59,130,246,.1);
  }

  /* WhatsApp */
  .btn.whatsapp{
    background: #25D366;
    color: #fff;
    box-shadow: 0 2px 8px rgba(37,211,102,.2);
  }
  .btn.whatsapp:hover{
    background: #1ebe5d;
    box-shadow: 0 4px 12px rgba(37,211,102,.3);
  }
  .btn.whatsapp:active{
    background: #1aa952;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    padding: 14px 16px 16px;
    position: relative;
  }

  @media (max-width: 860px){
    body{ padding: 18px 12px 34px; }
    .top{ align-items:flex-start; flex-direction:column; }
    .pill{ align-self:flex-start; }
    .grid{ grid-template-columns: 1fr; }
    select{ min-width: 170px; }
  }

  .panel{
    background: rgba(15,20,25,.4);
    border: 1px solid var(--stroke);
    border-radius: var(--radius2);
    padding: 16px;
    min-height: 280px;
    display:flex;
    flex-direction:column;
    gap: 12px;
  }

  .panel h2{
    margin:0;
    font-size: 13px;
    color: var(--text);
    font-weight: 600;
    letter-spacing:-0.2px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    min-height: 32px;
  }
  .small{
    font-size: 11px;
    color: var(--muted);
    font-weight: 500;
  }

  textarea{
    width:100%;
    flex: 1;
    resize: none;
    min-height: 200px;
    padding: 14px;
    border-radius: var(--radius2);
    border: 1px solid var(--stroke);
    background: rgba(15,20,25,.6);
    color: var(--text);
    outline:none;
    line-height:1.5;
    font-size: 14px;
    transition: border-color .2s ease;
  }
  textarea:focus{
    border-color: var(--accent);
  }

  .out{
    flex:1;
    padding: 14px;
    border-radius: var(--radius2);
    border: 1px solid var(--stroke);
    background: rgba(15,20,25,.6);
    white-space: pre-wrap;
    overflow:auto;
    min-height: 200px;
    line-height: 1.5;
    font-size: 14px;
  }

  .status{
    padding: 12px 16px 14px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    border-top: 1px solid rgba(255,255,255,.10);
    color: rgba(244,246,255,.72);
    font-size: 12px;
    position: relative;
  }

  .error{ color: var(--danger); font-weight: 800; }
  .ok{ color: var(--accent2); font-weight: 800; }

  .spinner{
    width: 14px; height: 14px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,.15);
    border-top-color: var(--accent);
    display:inline-block;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .toast{
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(26,31,46,.95);
    border: 1px solid var(--stroke);
    padding: 12px 20px;
    border-radius: 8px;
    color: var(--text);
    font-size: 13px;
    font-weight: 500;
    box-shadow: 0 12px 32px rgba(0,0,0,.3);
    backdrop-filter: blur(10px);
    opacity: 0;
    pointer-events:none;
    transition: opacity .2s ease;
  }
  .toast.show{ opacity: 1; }

  /* Chat Widget */
  .chat-widget{
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9999;
  }

  .chat-button{
    width: 62px;
    height: 62px;
    border-radius: 50%;
    background: #2563eb;
    border: 0;
    box-shadow: 0 4px 16px rgba(37,99,235,.3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    transition: transform .2s ease, box-shadow .2s ease;
  }
  .chat-button:hover{
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(37,99,235,.4);
  }
  .chat-button:active{
    transform: scale(0.95);
  }

  .chat-window{
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 380px;
    height: 550px;
    background: rgba(26,31,46,.95);
    border: 1px solid var(--stroke);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,.4);
    backdrop-filter: blur(20px);
    display: flex;
    flex-direction: column;
    opacity: 0;
    transform: translateY(20px) scale(0.95);
    pointer-events: none;
    transition: opacity .25s ease, transform .25s ease;
  }
  .chat-window.open{
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
  }

  .chat-header{
    padding: 18px 20px;
    background: rgba(37,99,235,.1);
    border-bottom: 1px solid var(--stroke);
    border-radius: 16px 16px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .chat-header-info{
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .chat-avatar{
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #2563eb;
    border: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 2px 8px rgba(37,99,235,.2);
  }

  .chat-header-text h3{
    margin: 0;
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
  }
  .chat-header-text p{
    margin: 2px 0 0;
    font-size: 11px;
    color: var(--muted);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .online-dot{
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: #10b981;
    box-shadow: 0 0 0 3px rgba(16,185,129,.15);
  }

  .chat-close{
    width: 32px;
    height: 32px;
    border: 0;
    background: rgba(255,255,255,.08);
    border-radius: 6px;
    color: var(--muted);
    font-weight: 400;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: background .2s ease, transform .2s ease;
  }
  .chat-close:hover{
    background: rgba(255,255,255,.12);
    transform: scale(1.1);
  }
  .chat-close:active{
    transform: scale(0.95);
  }

  .chat-messages{
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .chat-message{
    display: flex;
    gap: 10px;
    animation: messageSlide .3s ease;
  }
  @keyframes messageSlide {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chat-message.user{
    flex-direction: row-reverse;
  }

  .message-avatar{
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(46,229,157,.45));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
  }

  .chat-message.user .message-avatar{
    background: linear-gradient(135deg, rgba(46,229,157,.55), rgba(124,92,255,.45));
  }

  .message-bubble{
    max-width: 70%;
    padding: 12px 14px;
    border-radius: 16px;
    background: linear-gradient(135deg, rgba(0,255,255,.30), rgba(0,255,0,.25));
    border: 2px solid #00ffff;
    color: #fff;
    font-size: 13.5px;
    line-height: 1.5;
    font-weight: 600;
    box-shadow: 0 0 15px rgba(0,255,255,.40), 0 4px 12px rgba(0,0,0,.25);
  }

  .chat-message.user .message-bubble{
    background: rgba(37,99,235,.12);
    border-color: rgba(37,99,235,.30);
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
  }

  .message-time{
    font-size: 10px;
    color: rgba(244,246,255,.50);
    margin-top: 4px;
  }

  .chat-input-area{
    padding: 16px;
    border-top: 1px solid rgba(255,255,255,.10);
    background: rgba(6,8,18,.55);
    border-radius: 0 0 20px 20px;
  }

  .chat-input-wrapper{
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  .chat-input{
    flex: 1;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.50);
    color: #fff;
    font-size: 13px;
    font-weight: 600;
    outline: none;
    resize: none;
    max-height: 100px;
    font-family: inherit;
    line-height: 1.4;
    transition: border-color .15s ease, box-shadow .15s ease;
    box-shadow: none;
  }
  .chat-input:focus{
    border-color: rgba(37,99,235,.50);
    box-shadow: 0 0 0 3px rgba(37,99,235,.10);
  }

  .chat-send{
    width: 44px;
    height: 44px;
    border: none;
    border-radius: 12px;
    background: #2563eb;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: transform .08s ease, background .15s ease;
    box-shadow: 0 2px 8px rgba(37,99,235,.30);
    flex-shrink: 0;
  }
  .chat-send:hover{
    background: #1d4ed8;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(37,99,235,.40);
  }
  .chat-send:active{
    transform: scale(0.95);
    box-shadow: 0 1px 4px rgba(37,99,235,.30);
  }
  .chat-send:disabled{
    opacity: .5;
    cursor: not-allowed;
  }

  @media (max-width: 480px){
    .chat-window{
      width: calc(100vw - 24px);
      height: calc(100vh - 100px);
      bottom: 80px;
      right: 12px;
    }
    .chat-widget{
      right: 12px;
      bottom: 12px;
    }
  }

  .version{
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 6px 12px;
    border-radius: 6px;
    background: rgba(59,130,246,.1);
    border: 1px solid rgba(59,130,246,.2);
    color: var(--accent);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
    z-index: 9998;
  }
</style>
</head>

<body>
  <div class="version">v3.12</div>
  
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Traductor n8n + IA</h1>
          <div class="sub">Escribe el texto, elige el idioma destino y obt√©n la traducci√≥n al instante.</div>
        </div>
      </div>
      <div class="pill"><span class="dot"></span>Webhook activo (producci√≥n)</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="controls">
          <label for="target">Idioma destino</label>
          <select id="target" title="Idioma destino">
            <option value="es">Espa√±ol (es)</option>
            <option value="en">Ingl√©s (en)</option>
            <option value="fr">Franc√©s (fr)</option>
            <option value="pt">Portugu√©s (pt)</option>
            <option value="de">Alem√°n (de)</option>
            <option value="it">Italiano (it)</option>
          </select>

          <button class="btn" id="btn" type="button">
            <span id="btnIcon">ü™Ñ</span>
            <span id="btnText">Traducir</span>
          </button>

          <button class="btn ghost" id="btnClear" type="button">Limpiar</button>

          <!-- Bot√≥n WhatsApp -->
          <button class="btn whatsapp" id="shareWa" type="button" title="Compartir por WhatsApp">
            üì≤ WhatsApp
          </button>
        </div>

        <div class="small" id="charCount">0 caracteres</div>
      </div>

      <div class="grid">
        <div class="panel">
          <h2>
            Texto original
            <span class="small">Tip: puedes pegar p√°rrafos largos</span>
          </h2>
          <textarea id="text" placeholder="Ej: Hello world..."></textarea>
        </div>

        <div class="panel">
          <h2>
            Traducci√≥n
            <button class="btn secondary" id="copy" type="button">Copiar</button>
          </h2>
          <div id="out" class="out"></div>
        </div>
      </div>

      <div class="status">
        <div id="statusLeft"></div>
        <div id="statusRight">Fuente: Ollama (gemma3:1b) - Modo R√°pido</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Copiado ‚úÖ</div>

  <!-- Chat Widget -->
  <div class="chat-widget">
    <button class="chat-button" id="chatToggle" type="button" aria-label="Abrir chat">
      üí¨
    </button>

    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <div class="chat-header-info">
          <div class="chat-avatar">ü§ñ</div>
          <div class="chat-header-text">
            <h3>Soporte IA</h3>
            <p><span class="online-dot"></span>En l√≠nea</p>
          </div>
        </div>
        <button class="chat-close" id="chatClose" type="button" aria-label="Cerrar chat">‚úï</button>
      </div>

      <div class="chat-messages" id="chatMessages">
        <!-- Los mensajes se agregan din√°micamente -->
      </div>

      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea 
            class="chat-input" 
            id="chatInput" 
            placeholder="Escribe tu mensaje..."
            rows="1"></textarea>
          <button class="chat-send" id="chatSend" type="button" aria-label="Enviar mensaje">üì§</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n: Las peticiones van al mismo servidor (proxy autom√°tico)
    // En local: http://localhost:8080/api/chat
    // En ngrok: https://tu-url.ngrok-free.app/api/chat
    function getApiUrl(endpoint) {
      // Usar la misma URL del sitio actual (el servidor hace proxy a Ollama)
      return endpoint; // Ya incluye /api/chat
    }

    const $ = (id) => document.getElementById(id);
    const btn = $("btn");
    const btnText = $("btnText");
    const btnIcon = $("btnIcon");
    const out = $("out");
    const statusLeft = $("statusLeft");
    const statusRight = $("statusRight");
    const charCount = $("charCount");
    const toast = $("toast");

    function toastShow(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=> toast.classList.remove("show"), 1200);
    }

    function setLoading(isLoading){
      btn.disabled = isLoading;
      btnIcon.innerHTML = isLoading ? "<span class='spinner'></span>" : "ü™Ñ";
      btnText.textContent = isLoading ? "Traduciendo..." : "Traducir";
    }

    $("text").addEventListener("input", () => {
      charCount.textContent = `${$("text").value.length} caracteres`;
    });

    $("btnClear").addEventListener("click", () => {
      $("text").value = "";
      out.textContent = "";
      statusLeft.textContent = "Listo.";
      charCount.textContent = "0 caracteres";
    });

    $("copy").addEventListener("click", async () => {
      const txt = out.textContent.trim();
      if (!txt) return toastShow("Nada para copiar");
      try{
        await navigator.clipboard.writeText(txt);
        toastShow("Copiado ‚úÖ");
      }catch{
        toastShow("No se pudo copiar");
      }
    });

    // ‚úÖ Compartir traducci√≥n por WhatsApp
    $("shareWa").addEventListener("click", () => {
      const translation = out.textContent.trim();
      
      if (!translation) {
        toastShow("No hay traducci√≥n para compartir");
        return;
      }
      
      const url = window.location.href;
      const message = `${translation}\n\nTraducido mediante el servicio ${url}`;
      const waUrl = "https://wa.me/?text=" + encodeURIComponent(message);
      window.open(waUrl, "_blank");
    });

    btn.addEventListener("click", async () => {
      const text = $("text").value.trim();
      const target = $("target").value;

      if (!text){
        out.innerHTML = "<span style='color: var(--danger); font-weight:700;'>Escribe un texto para traducir.</span>";
        statusLeft.innerHTML = "<span class='error'>Falta texto.</span>";
        return;
      }

      setLoading(true);
      statusLeft.textContent = "Traduciendo con IA...";

      try{
        // Mapa de c√≥digos de idioma a nombres completos
        const languages = {
          'es': 'espa√±ol',
          'en': 'ingl√©s',
          'fr': 'franc√©s',
          'pt': 'portugu√©s',
          'de': 'alem√°n',
          'it': 'italiano'
        };

        const targetLang = languages[target] || target;

        // Timeout personalizado para la petici√≥n
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 segundos

        // Llamada a Ollama para traducci√≥n
        const res = await fetch(getApiUrl("/api/chat"), {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model: "gemma3:1b",
              messages: [
                {
                  role: "system",
                  content: `Eres un traductor profesional. Tu √∫nica tarea es traducir el texto que te proporcionen al idioma ${targetLang}. Responde √öNICAMENTE con la traducci√≥n, sin explicaciones, sin comentarios adicionales, solo el texto traducido.`
              },
              {
                role: "user",
                content: text
              }
            ],
            stream: false
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!res.ok){
          const errorText = await res.text().catch(() => "");
          console.error("Error del servidor:", res.status, res.statusText, errorText);
          out.innerHTML = "<span class='error'>Error en el servidor (" + res.status + "): " + (errorText || res.statusText || "Error desconocido") + "</span>";
          statusLeft.innerHTML = "<span class='error'>Error " + res.status + "</span>";
        } else {
          const data = await res.json();
          const translation = data.message?.content || "(sin traducci√≥n)";
          out.textContent = translation;
          statusLeft.innerHTML = "<span class='ok'>‚úì</span> Traducido a <b>"+ targetLang +"</b>";
        }
      }catch(e){
        console.error("Error de traducci√≥n completo:", e);
        if (e.name === 'AbortError') {
          out.innerHTML = "<span class='error'>‚è±Ô∏è El servidor tard√≥ demasiado en responder. Intenta con un texto m√°s corto.</span>";
          statusLeft.innerHTML = "<span class='error'>Timeout.</span>";
        } else {
          out.innerHTML = "<span class='error'>‚ùå Error de conexi√≥n: " + e.message + "<br>Verifica la consola del navegador (F12) para m√°s detalles.</span>";
          statusLeft.innerHTML = "<span class='error'>Sin conexi√≥n.</span>";
        }
      }finally{
        setLoading(false);
      }
    });

    // Chat Widget functionality
    const chatToggle = $("chatToggle");
    const chatWindow = $("chatWindow");
    const chatClose = $("chatClose");
    const chatMessages = $("chatMessages");
    const chatInput = $("chatInput");
    const chatSend = $("chatSend");

    // Funci√≥n para obtener hora actual
    function getCurrentTime(){
      const now = new Date();
      return now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    }

    // Funci√≥n para agregar mensaje al chat
    function addMessage(text, isUser = false){
      const messageDiv = document.createElement("div");
      messageDiv.className = "chat-message" + (isUser ? " user" : "");
      
      const avatar = document.createElement("div");
      avatar.className = "message-avatar";
      avatar.textContent = isUser ? "üë§" : "ü§ñ";
      
      const contentDiv = document.createElement("div");
      
      const bubble = document.createElement("div");
      bubble.className = "message-bubble";
      bubble.textContent = text;
      
      const time = document.createElement("div");
      time.className = "message-time";
      time.textContent = getCurrentTime();
      
      contentDiv.appendChild(bubble);
      contentDiv.appendChild(time);
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Mensaje de bienvenida al abrir el chat por primera vez
    let chatOpened = false;
    
    function toggleChat(){
      chatWindow.classList.toggle("open");
      if(chatWindow.classList.contains("open")){
        chatInput.focus();
        
        // Mostrar mensaje de bienvenida solo la primera vez
        if(!chatOpened){
          chatOpened = true;
          setTimeout(() => {
            addMessage("¬°Hola! üëã Bienvenido al Traductor n8n + IA");
          }, 300);
          setTimeout(() => {
            addMessage("Soy tu asistente virtual. ¬øEn qu√© puedo ayudarte hoy?");
          }, 900);
          setTimeout(() => {
            addMessage("Puedo responder preguntas sobre c√≥mo usar el traductor, los idiomas disponibles, o cualquier duda que tengas. üòä");
          }, 1500);
        }
      }
    }

    chatToggle.addEventListener("click", toggleChat);
    chatClose.addEventListener("click", toggleChat);

    // Auto-resize textarea
    chatInput.addEventListener("input", function(){
      this.style.height = "auto";
      this.style.height = Math.min(this.scrollHeight, 100) + "px";
    });

    // Enviar mensaje con Enter (Shift+Enter para nueva l√≠nea)
    chatInput.addEventListener("keydown", function(e){
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        chatSend.click();
      }
    });

    // Funci√≥n para enviar mensaje a n8n
    chatSend.addEventListener("click", async function(){
      const message = chatInput.value.trim();
      if(!message) return;

      // Guardar el mensaje antes de limpiar
      const userMessage = message;
      
      // Limpiar input primero
      chatInput.value = "";
      chatInput.style.height = "auto";

      // Mostrar mensaje del usuario
      addMessage(userMessage, true);

      // Deshabilitar bot√≥n mientras se procesa
      chatSend.disabled = true;

      // Mostrar indicador de escritura
      const typingDiv = document.createElement("div");
      typingDiv.className = "chat-message";
      typingDiv.id = "typing-indicator";
      typingDiv.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div>
          <div class="message-bubble">
            <span class="spinner"></span> Escribiendo...
          </div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      try {
        // Llamada a n8n webhook para chat
        const response = await fetch("/webhook/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: userMessage,
            context: "Traductor n8n + IA"
          })
        });

        // Remover indicador de escritura
        const typing = document.getElementById("typing-indicator");
        if(typing) typing.remove();

        if(response.ok){
          const data = await response.json();
          const aiResponse = data.response || data.message || data.text || "Lo siento, no pude generar una respuesta.";
          addMessage(aiResponse);
        } else {
          addMessage("Lo siento, hubo un error al conectar con el servidor. Por favor intenta nuevamente.");
        }
      } catch(error) {
        console.error("Error:", error);
        const typing = document.getElementById("typing-indicator");
        if(typing) typing.remove();
        addMessage("No pude conectarme al servidor. Verifica que n8n est√© activo y el workflow configurado.");
      } finally {
        chatSend.disabled = false;
      }
    });
  </script>
</body>
</html>

